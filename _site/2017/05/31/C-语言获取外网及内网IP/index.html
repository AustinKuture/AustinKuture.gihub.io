<!DOCTYPE html>
<html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <title>C 语言获取外网及内网IP &mdash; Kuture</title>
    <link rel="stylesheet" href="http://localhost:4000/assets/vendor/primer-css/css/primer.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/vendor/primer-markdown/dist/user-content.min.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/vendor/octicons/octicons/octicons.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/components/collection.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/components/repo-card.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/sections/repo-list.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/sections/mini-repo-list.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/components/boxed-group.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/globals/common.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/vendor/share.js/dist/css/share.min.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/globals/responsive.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/posts/index.css">
    <!-- Latest compiled and minified CSS -->
    

    
    <link rel="canonical" href="http://localhost:4000/2017/05/31/C-%E8%AF%AD%E8%A8%80%E8%8E%B7%E5%8F%96%E5%A4%96%E7%BD%91%E5%8F%8A%E5%86%85%E7%BD%91IP/">
    <link rel="alternate" type="application/atom+xml" title="Kuture" href="http://localhost:4000/feed.xml">
    <link rel="shortcut icon" href="http://localhost:4000/favicon.ico">
    
    <meta property="og:title" content="C 语言获取外网及内网IP">
      
    <meta name="keywords" content="C,IP">
    <meta name="og:keywords" content="C,IP">
      
    <meta name="description" content="C 语言获取外网及内网IP">
    <meta name="og:description" content="C 语言获取外网及内网IP">
      
    
    
        
    
    <meta property="og:url" content="http://localhost:4000/2017/05/31/C-%E8%AF%AD%E8%A8%80%E8%8E%B7%E5%8F%96%E5%A4%96%E7%BD%91%E5%8F%8A%E5%86%85%E7%BD%91IP/">
    <meta property="og:site_name" content="Kuture">
    <meta property="og:type" content="article">
    <meta property="og:locale" content="zh_CN" />
    
    <meta property="article:published_time" content="2017-05-31">
    
    <script src="http://localhost:4000/assets/vendor/jquery/dist/jquery.min.js"></script>
    <script src="http://localhost:4000/assets/js/jquery-ui.js"></script>
    <script type="text/javascript">
    function toggleMenu() {
        var nav = document.getElementsByClassName("site-header-nav")[0];
        if (nav.style.display == "inline-flex") {
          nav.style.display = "none";
        } else {
          nav.style.display = "inline-flex";
        }
    }
    </script>
</head>
<body class="" data-mz="">
    <header class="site-header">
        <div class="container">
            <h1><a href="http://localhost:4000/" title="Kuture"><span class="octicon octicon-mark-github"></span> Kuture</a></h1>
            <button class="collapsed mobile-visible" type="button" onclick="toggleMenu();">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <nav class="site-header-nav" role="navigation">
                
                <a href="http://localhost:4000/" class=" site-header-nav-item" target="" title="首页">首页</a>
                
                <a href="http://localhost:4000/categories/" class=" site-header-nav-item" target="" title="分类">分类</a>
                
                <a href="http://localhost:4000/wiki/" class=" site-header-nav-item" target="" title="百科">百科</a>
                
                <a href="http://localhost:4000/links/" class=" site-header-nav-item" target="" title="链接">链接</a>
                
                <a href="http://localhost:4000/about/" class=" site-header-nav-item" target="" title="关于">关于</a>
                
            </nav>
        </div>
    </header>
    <!-- / header -->

    <section class="collection-head small geopattern" data-pattern-id="C 语言获取外网及内网IP">
<div class="container">
  <div class="columns">
    <div class="column three-fourths">
      <div class="collection-title">
        <h1 class="collection-header">C 语言获取外网及内网IP</h1>
        <div class="collection-info">
          
          <span class="meta-info">
            <span class="octicon octicon-calendar"></span> 2017/05/31
          </span>
          
          
          <span class="meta-info">
            <span class="octicon octicon-file-directory"></span>
            <a href="http://localhost:4000/categories/#C" title="C">C</a>
          </span>
          
        </div>
      </div>
    </div>
  </div>
</div>
</section>
<!-- / .banner -->
<section class="container content">
<div class="columns">
  <div class="column three-fourths" >
    <article class="article-content markdown-body">
    <h1 id="c-语言获取外网及内网ip">C 语言获取外网及内网IP</h1>

<p>作者:<strong>AustinKuture</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>摘要: 移动或网站开发中经常需要设备或网站内网及外网IP,
     本篇文章讲解如何使用C语言获取外网及内网IP.
</code></pre></div></div>

<h2 id="1-引入头文件">1, 引入头文件</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/ioctl.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/socket.h&gt;
#include &lt;net/ethernet.h&gt;
#include &lt;netinet/in.h&gt;
#include &lt;netdb.h&gt;
#include &lt;arpa/inet.h&gt;
#include &lt;sys/sockio.h&gt;
#include &lt;net/if.h&gt;
#include &lt;errno.h&gt;
#include &lt;net/if_dl.h&gt;
</code></pre></div></div>

<h2 id="2添加所需要的常量">2,添加所需要的常量</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#define min(a,b)    ((a) &lt; (b) ? (a) : (b))
#define max(a,b)    ((a) &gt; (b) ? (a) : (b))
#define MAXADDRS 32
#define BUFFERSIZE  4000

char *if_names[MAXADDRS];
char *ip_names[MAXADDRS];
char *hw_addrs[MAXADDRS];
unsigned long ip_addrs[MAXADDRS];

static int   nextAddr = 0;
</code></pre></div></div>

<h2 id="3实现获取内网ip的方法">3,实现获取内网IP的方法</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/*
 * 获取内网IP
 */

void InitAddresses(){
    int i;
    for (i=0; i&lt;MAXADDRS; ++i)
    {
        if_names[i] = ip_names[i] = hw_addrs[i] = NULL;
        ip_addrs[i] = 0;
    }
}

void FreeAddresses(){
    int i;
    for (i=0; i&lt;MAXADDRS; ++i)
    {
        if (if_names[i] != 0) free(if_names[i]);
        if (ip_names[i] != 0) free(ip_names[i]);
        if (hw_addrs[i] != 0) free(hw_addrs[i]);
        ip_addrs[i] = 0;
    }
    InitAddresses();
}

void GetIPAddresses(){

    int                 i, len, flags;
    char                buffer[BUFFERSIZE], *ptr, lastname[IFNAMSIZ], *cptr;
    struct ifconf       ifc;
    struct ifreq        *ifr, ifrcopy;
    struct sockaddr_in  *sin;

    char temp[80];

    int sockfd;

    for (i=0; i&lt;MAXADDRS; ++i)
    {
        if_names[i] = ip_names[i] = NULL;
        ip_addrs[i] = 0;
    }

    sockfd = socket(AF_INET, SOCK_DGRAM, 0);
    if (sockfd &lt; 0)
    {
        perror("socket failed");
        return;
    }

    ifc.ifc_len = BUFFERSIZE;
    ifc.ifc_buf = buffer;

    if (ioctl(sockfd, SIOCGIFCONF, &amp;ifc) &lt; 0)
    {
        perror("ioctl error");
        return;
    }

    lastname[0] = 0;

    for (ptr = buffer; ptr &lt; buffer + ifc.ifc_len; )
    {
        ifr = (struct ifreq *)ptr;
        len = max(sizeof(struct sockaddr), ifr-&gt;ifr_addr.sa_len);
        ptr += sizeof(ifr-&gt;ifr_name) + len;  // for next one in buffer

        if (ifr-&gt;ifr_addr.sa_family != AF_INET)
        {
            continue;   // ignore if not desired address family
        }

        if ((cptr = (char *)strchr(ifr-&gt;ifr_name, ':')) != NULL)
        {
            *cptr = 0;      // replace colon will null
        }

        if (strncmp(lastname, ifr-&gt;ifr_name, IFNAMSIZ) == 0)
        {
            continue;   /* already processed this interface */
        }

        memcpy(lastname, ifr-&gt;ifr_name, IFNAMSIZ);

        ifrcopy = *ifr;
        ioctl(sockfd, SIOCGIFFLAGS, &amp;ifrcopy);
        flags = ifrcopy.ifr_flags;
        if ((flags &amp; IFF_UP) == 0)
        {
            continue;   // ignore if interface not up
        }

        if_names[nextAddr] = (char *)malloc(strlen(ifr-&gt;ifr_name)+1);
        if (if_names[nextAddr] == NULL)
        {
            return;
        }
        strcpy(if_names[nextAddr], ifr-&gt;ifr_name);

        sin = (struct sockaddr_in *)&amp;ifr-&gt;ifr_addr;
        strcpy(temp, inet_ntoa(sin-&gt;sin_addr));

        ip_names[nextAddr] = (char *)malloc(strlen(temp)+1);
        if (ip_names[nextAddr] == NULL)
        {
            return;
        }
        strcpy(ip_names[nextAddr], temp);

        ip_addrs[nextAddr] = sin-&gt;sin_addr.s_addr;

        ++nextAddr;
    }

    close(sockfd);
}

void GetHWAddresses(){

    struct ifconf ifc;
    struct ifreq *ifr;
    int i, sockfd;
    char buffer[BUFFERSIZE], *cp, *cplim;
    char temp[80];

    for (i=0; i&lt;MAXADDRS; ++i)
    {
        hw_addrs[i] = NULL;
    }

    sockfd = socket(AF_INET, SOCK_DGRAM, 0);
    if (sockfd &lt; 0)
    {
        perror("socket failed");
        return;
    }

    ifc.ifc_len = BUFFERSIZE;
    ifc.ifc_buf = buffer;

    if (ioctl(sockfd, SIOCGIFCONF, (char *)&amp;ifc) &lt; 0)
    {
        perror("ioctl error");
        close(sockfd);
        return;
    }

    ifr = ifc.ifc_req;

    cplim = buffer + ifc.ifc_len;

    for (cp=buffer; cp &lt; cplim; )
    {
        ifr = (struct ifreq *)cp;
        if (ifr-&gt;ifr_addr.sa_family == AF_LINK)
        {
            struct sockaddr_dl *sdl = (struct sockaddr_dl *)&amp;ifr-&gt;ifr_addr;
            int a,b,c,d,e,f;
            int i;

            strcpy(temp, (char *)ether_ntoa(LLADDR(sdl)));
            sscanf(temp, "%x:%x:%x:%x:%x:%x", &amp;a, &amp;b, &amp;c, &amp;d, &amp;e, &amp;f);
            sprintf(temp, "%02X:%02X:%02X:%02X:%02X:%02X",a,b,c,d,e,f);

            for (i=0; i&lt;MAXADDRS; ++i)
            {
                if ((if_names[i] != NULL) &amp;&amp; (strcmp(ifr-&gt;ifr_name, if_names[i]) == 0))
                {
                    if (hw_addrs[i] == NULL)
                    {
                        hw_addrs[i] = (char *)malloc(strlen(temp)+1);
                        strcpy(hw_addrs[i], temp);
                        break;
                    }
                }
            }
        }
        cp += sizeof(ifr-&gt;ifr_name) + max(sizeof(ifr-&gt;ifr_addr), ifr-&gt;ifr_addr.sa_len);
    }

    close(sockfd);
}
</code></pre></div></div>

<h2 id="4实现获取外网ip的方法">4,实现获取外网IP的方法</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/*
 * 获取外网IP
 */
- (char *)getPublicIPAdressWithHostName:(char *)hostName{

    int    sock;
    char **pptr = NULL;
    struct sockaddr_in    destAddr;
    struct hostent    *ptr = NULL;
    char destIP[128];

    sock = socket(AF_INET,SOCK_STREAM,0);
    if( -1 == sock ){
        perror("creat socket failed");
        return false;
    }
    bzero((void *)&amp;destAddr,sizeof(destAddr));
    destAddr.sin_family = AF_INET;
    destAddr.sin_port = htons(80);
    ptr = gethostbyname(hostName);
    if(NULL == ptr){
        perror("gethostbyname error");
        return false;
    }
    for(pptr=ptr-&gt;h_addr_list ; NULL != *pptr ; ++pptr){
        inet_ntop(ptr-&gt;h_addrtype,*pptr,destIP,sizeof(destIP));
        printf("addr:%s\n",destIP);
        return destIP;
    }
    return destIP;
}
</code></pre></div></div>

<h2 id="5实现方法此处我们以ios项目为例其他兼容c语言的项目同样适用">5,实现方法,此处我们以iOS项目为例,其他兼容C语言的项目同样适用</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//返回内网IP的的方法,在需要内网IP的地方直接调用deviceIPAdress方法即可
- (NSString *)deviceIPAdress {

    InitAddresses();
    GetIPAddresses();
    GetHWAddresses();

    return [NSString stringWithFormat:@"%s", ip_names[1]];
}

//同理获取外网IP时直接调用- (char *)getPublicIPAdressWithHostName:(char *)hostName方法即可,例如

[NSString stringWithFormat:@"%s",[self getPublicIPAdressWithHostName:"www.baidu.com"]];-
</code></pre></div></div>


    </article>
    <div class="share">
      <div class="share-component"></div>
    </div>
    <div class="comment">
      

  

  


    </div>
  </div>
  <div class="column one-fourth">
    
<h3>Search</h3>
<div id="site_search">
    <input type="text" id="search_box" placeholder="Search">
</div>

<ul id="search_results"></ul>

<link rel="stylesheet" type="text/css" href="http://localhost:4000/assets/css/modules/sidebar-search.css">
<script src="http://localhost:4000/assets/js/simple-jekyll-search.min.js"></script>
<script src="http://localhost:4000/assets/js/search.js"></script>

<script type="text/javascript">
SimpleJekyllSearch({
    searchInput: document.getElementById('search_box'),
    resultsContainer: document.getElementById('search_results'),
    json: 'http://localhost:4000/assets/search_data.json',
    searchResultTemplate: '<li><a href="{url}" title="{desc}">{title}</a></li>',
    noResultsText: 'No results found',
    limit: 10,
    fuzzy: false,
    exclude: ['Welcome']
})
</script>

    

    
<h3 class="post-directory-title mobile-hidden">Table of Contents</h3>
<div id="post-directory-module" class="mobile-hidden">
  <section class="post-directory">
  <!-- Links that trigger the jumping -->
  <!-- Added by javascript below -->
  <dl></dl>
  </section>
</div>

<script src="http://localhost:4000/assets/js/jquery.toc.js"></script>

  </div>
</div>
</section>
<!-- /section.content -->

    <footer class="container">
        <div class="site-footer" role="contentinfo">
            <div class="copyright left mobile-block">
                    © 2015
                    <span title="Yakun">Yakun</span>
                    <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a>
            </div>

            <ul class="site-footer-links right mobile-hidden">
                <li>
                    <a href="javascript:window.scrollTo(0,0)" >TOP</a>
                </li>
            </ul>
            <a href="http://github.com/AustinKuture/austinkuture.github.io" target="_blank" aria-label="view source code">
                <span class="mega-octicon octicon-mark-github" title="GitHub"></span>
            </a>
            <ul class="site-footer-links mobile-hidden">
                
                <li>
                    <a href="http://localhost:4000/" title="首页" target="">首页</a>
                </li>
                
                <li>
                    <a href="http://localhost:4000/categories/" title="分类" target="">分类</a>
                </li>
                
                <li>
                    <a href="http://localhost:4000/wiki/" title="百科" target="">百科</a>
                </li>
                
                <li>
                    <a href="http://localhost:4000/links/" title="链接" target="">链接</a>
                </li>
                
                <li>
                    <a href="http://localhost:4000/about/" title="关于" target="">关于</a>
                </li>
                
                <li><a href="http://localhost:4000/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li>
            </ul>

        </div>
    </footer>
    <!-- / footer -->
    <script src="http://localhost:4000/assets/vendor/share.js/dist/js/share.min.js"></script>
    <script src="http://localhost:4000/assets/js/geopattern.js"></script>
    <script src="http://localhost:4000/assets/js/prism.js"></script>
    <link rel="stylesheet" href="http://localhost:4000/assets/css/globals/prism.css">
    <script>
      jQuery(document).ready(function($) {
        // geopattern
        $('.geopattern').each(function(){
          $(this).geopattern($(this).data('pattern-id'));
        });
       // hljs.initHighlightingOnLoad();
      });
    </script>

    

    

    

    

    
    <div style="display:none">
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-80669434-1', 'auto');
        ga('send', 'pageview');

      </script>
    </div>
    
</body>
</html>
