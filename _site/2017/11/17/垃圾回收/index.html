<!DOCTYPE html>
<html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <title>Python中的垃圾回收机制 &mdash; Kuture</title>
    <link rel="stylesheet" href="http://localhost:4000/assets/vendor/primer-css/css/primer.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/vendor/primer-markdown/dist/user-content.min.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/vendor/octicons/octicons/octicons.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/components/collection.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/components/repo-card.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/sections/repo-list.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/sections/mini-repo-list.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/components/boxed-group.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/globals/common.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/vendor/share.js/dist/css/share.min.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/globals/responsive.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/posts/index.css">
    <!-- Latest compiled and minified CSS -->
    

    
    <link rel="canonical" href="http://localhost:4000/2017/11/17/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/">
    <link rel="alternate" type="application/atom+xml" title="Kuture" href="http://localhost:4000/feed.xml">
    <link rel="shortcut icon" href="http://localhost:4000/favicon.ico">
    
    <meta property="og:title" content="Python中的垃圾回收机制">
      
    <meta name="keywords" content="Python, 垃圾回收">
    <meta name="og:keywords" content="Python, 垃圾回收">
      
    <meta name="description" content="1、小整数对象池">
    <meta name="og:description" content="1、小整数对象池">
      
    
    
        
    
    <meta property="og:url" content="http://localhost:4000/2017/11/17/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/">
    <meta property="og:site_name" content="Kuture">
    <meta property="og:type" content="article">
    <meta property="og:locale" content="zh_CN" />
    
    <meta property="article:published_time" content="2017-11-17">
    
    <script src="http://localhost:4000/assets/vendor/jquery/dist/jquery.min.js"></script>
    <script src="http://localhost:4000/assets/js/jquery-ui.js"></script>
    <script type="text/javascript">
    function toggleMenu() {
        var nav = document.getElementsByClassName("site-header-nav")[0];
        if (nav.style.display == "inline-flex") {
          nav.style.display = "none";
        } else {
          nav.style.display = "inline-flex";
        }
    }
    </script>
</head>
<body class="" data-mz="">
    <header class="site-header">
        <div class="container">
            <h1><a href="http://localhost:4000/" title="Kuture"><span class="octicon octicon-mark-github"></span> Kuture</a></h1>
            <button class="collapsed mobile-visible" type="button" onclick="toggleMenu();">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <nav class="site-header-nav" role="navigation">
                
                <a href="http://localhost:4000/" class=" site-header-nav-item" target="" title="首页">首页</a>
                
                <a href="http://localhost:4000/categories/" class=" site-header-nav-item" target="" title="分类">分类</a>
                
                <a href="http://localhost:4000/wiki/" class=" site-header-nav-item" target="" title="维基">维基</a>
                
                <a href="http://localhost:4000/links/" class=" site-header-nav-item" target="" title="链接">链接</a>
                
                <a href="http://localhost:4000/about/" class=" site-header-nav-item" target="" title="关于">关于</a>
                
            </nav>
        </div>
    </header>
    <!-- / header -->

    <section class="collection-head small geopattern" data-pattern-id="Python中的垃圾回收机制">
<div class="container">
  <div class="columns">
    <div class="column three-fourths">
      <div class="collection-title">
        <h1 class="collection-header">Python中的垃圾回收机制</h1>
        <div class="collection-info">
          
          <span class="meta-info">
            <span class="octicon octicon-calendar"></span> 2017/11/17
          </span>
          
          
          <span class="meta-info">
            <span class="octicon octicon-file-directory"></span>
            <a href="http://localhost:4000/categories/#Python" title="Python">Python</a>
          </span>
          
        </div>
      </div>
    </div>
  </div>
</div>
</section>
<!-- / .banner -->
<section class="container content">
<div class="columns">
  <div class="column three-fourths" >
    <article class="article-content markdown-body">
    <h4 id="1小整数对象池">1、小整数对象池</h4>

<p>在程序中整数的使用非常的广泛，Python为了优化速度，使用了小整数对象池，避免为整数频繁申请和销毁内存的空间。
Python中对象小整数的定义时[-5,256]，这些整数的对象时提前建立好的，不会被垃圾回收。在一个Python的程序中，所有位于这个范围内的整数使用的都是同一个对象。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">a</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="nb">id</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="mi">10911520</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="n">b</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="nb">id</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="mi">10911520</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">256</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="nb">id</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="mi">10919872</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="n">d</span> <span class="o">=</span> <span class="mi">256</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="nb">id</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="mi">10919872</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="n">e</span> <span class="o">=</span> <span class="mi">257</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">10</span><span class="p">]:</span> <span class="nb">id</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">10</span><span class="p">]:</span> <span class="mi">139826489334128</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">11</span><span class="p">]:</span> <span class="n">f</span> <span class="o">=</span> <span class="o">-</span><span class="mi">6</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">12</span><span class="p">]:</span> <span class="nb">id</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">12</span><span class="p">]:</span> <span class="mi">139826489334064</span>

</code></pre></div></div>

<p>​	上面中，我们可以看到范围在[-5,256]之间的整数，包含-5和256，对象在内存中的地址是相同的，同理，单个字母也是这样。</p>

<p>​	但是当定义两个相同的字符串时，引用计数为0,那么就会触发垃圾回收。</p>

<h4 id="2大整数对象池">2、大整数对象池</h4>

<p>每一个大整数，均创建一个新的对象。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">In</span> <span class="p">[</span><span class="mi">14</span><span class="p">]:</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">1234</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">15</span><span class="p">]:</span> <span class="nb">id</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">15</span><span class="p">]:</span> <span class="mi">139826489334576</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">16</span><span class="p">]:</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">1234</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">17</span><span class="p">]:</span> <span class="nb">id</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">17</span><span class="p">]:</span> <span class="mi">139826489334640</span>


</code></pre></div></div>

<h4 id="3intern机制">3、intern机制</h4>

<p>假如有好多个对象：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">a1</span> <span class="o">=</span> <span class="s">"HelloWorld"</span>
<span class="n">a2</span> <span class="o">=</span> <span class="s">"HelloWorld"</span>
<span class="n">a3</span> <span class="o">=</span> <span class="s">"HelloWorld"</span>
<span class="n">a4</span> <span class="o">=</span> <span class="s">"HelloWorld"</span>
<span class="n">a5</span> <span class="o">=</span> <span class="s">"HelloWorld"</span>
<span class="n">a6</span> <span class="o">=</span> <span class="s">"HelloWorld"</span>
<span class="n">a7</span> <span class="o">=</span> <span class="s">"HelloWorld"</span>
<span class="n">a8</span> <span class="o">=</span> <span class="s">"HelloWorld"</span>
</code></pre></div></div>

<p>python会不会创建8个对象呢？会不会在内存中开辟8个内存 空间？
答案是不会的，想一下，如果我们写10000个对象，像上面那样，那岂不是会在内存中开辟10000个空间，那得占用多少的内存。所以在Python中有这样的一个机制—-&gt;<code class="highlighter-rouge">intern机制</code>，</p>

<p>让他只占用一个“HelloWorld”所占的空间，靠引用计数去维护何时释放。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">In</span> <span class="p">[</span><span class="mi">19</span><span class="p">]:</span> <span class="n">a</span> <span class="o">=</span> <span class="s">'abcd'</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">20</span><span class="p">]:</span> <span class="nb">id</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">20</span><span class="p">]:</span> <span class="mi">139826471344368</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">21</span><span class="p">]:</span> <span class="n">b</span> <span class="o">=</span> <span class="s">'abcd'</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">22</span><span class="p">]:</span> <span class="nb">id</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">22</span><span class="p">]:</span> <span class="mi">139826471344368</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">23</span><span class="p">]:</span> <span class="n">c</span> <span class="o">=</span> <span class="n">b</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">24</span><span class="p">]:</span> <span class="nb">id</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">24</span><span class="p">]:</span> <span class="mi">139826471344368</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">25</span><span class="p">]:</span> <span class="k">del</span> <span class="n">a</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">26</span><span class="p">]:</span> <span class="k">del</span> <span class="n">b</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">27</span><span class="p">]:</span> <span class="nb">id</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">27</span><span class="p">]:</span> <span class="mi">139826471344368</span>

</code></pre></div></div>

<h4 id="总结"><strong>总结</strong></h4>

<ul>
  <li>
    <p>小整数[-5,256]共用内存，常驻内存。</p>
  </li>
  <li>
    <p>单个字符公用内存，常驻内存</p>
  </li>
  <li>
    <p>单个单词，不可修改，默认开启intern机制，公用内存，引用计数为0，则销毁</p>
  </li>
  <li>
    <p>字符串(含有空格)，不可修改，没开启intern机制，不共用对象，引用计数为0，销毁</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">In</span> <span class="p">[</span><span class="mi">30</span><span class="p">]:</span> <span class="n">a</span> <span class="o">=</span> <span class="s">'hello world'</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">31</span><span class="p">]:</span> <span class="n">b</span> <span class="o">=</span> <span class="s">'hello world'</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">32</span><span class="p">]:</span> <span class="nb">id</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">32</span><span class="p">]:</span> <span class="mi">139826489193264</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">33</span><span class="p">]:</span> <span class="nb">id</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">33</span><span class="p">]:</span> <span class="mi">139826489192816</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">34</span><span class="p">]:</span> <span class="n">c</span> <span class="o">=</span> <span class="s">'helloworld'</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">35</span><span class="p">]:</span> <span class="n">d</span> <span class="o">=</span> <span class="s">'helloworld'</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">36</span><span class="p">]:</span> <span class="nb">id</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">36</span><span class="p">]:</span> <span class="mi">139826486896048</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">37</span><span class="p">]:</span> <span class="nb">id</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">37</span><span class="p">]:</span> <span class="mi">139826486896048</span>

</code></pre></div>    </div>
  </li>
  <li>
    <p>大整数不共用内存，引用计数为0，销毁</p>
  </li>
  <li>
    <p>数值类型和字符串类型在Python中都是不可变的数据类型，这意味着你无法修改这个对象的值，每次对变量的修改，实际上是创建了一个新的对象。</p>
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">In</span> <span class="p">[</span><span class="mi">39</span><span class="p">]:</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">110</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">40</span><span class="p">]:</span> <span class="nb">id</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">40</span><span class="p">]:</span> <span class="mi">10915200</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">41</span><span class="p">]:</span> <span class="n">a</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">42</span><span class="p">]:</span> <span class="nb">id</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">42</span><span class="p">]:</span> <span class="mi">10915232</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">43</span><span class="p">]:</span> <span class="n">b</span> <span class="o">=</span> <span class="s">'hello'</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">44</span><span class="p">]:</span> <span class="nb">id</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">44</span><span class="p">]:</span> <span class="mi">139826471345768</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">45</span><span class="p">]:</span> <span class="n">b</span> <span class="o">=</span> <span class="s">'world'</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">46</span><span class="p">]:</span> <span class="nb">id</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">46</span><span class="p">]:</span> <span class="mi">139826471344368</span>
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="4garbage-collectiongc垃圾回收">4、Garbage collection(GC垃圾回收)</h4>

<p>python采用的是引用计数机制为主，分代收集机制为辅的策略</p>

<p>当引用计数为0时，该对象的生命就结束了</p>

<ul>
  <li>
    <p><strong>引用计数机制的优点：</strong></p>

    <ul>
      <li>
        <p>简单</p>
      </li>
      <li>
        <p>实时性：一旦没有引用，即引用计数为0，内存就直接释放了。不用像其他机制等到特定的时机，实时性还带来一个好处：处理回收内存的时间分摊到了平时</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>引用计数机制的缺点：</strong></p>

    <ul>
      <li>
        <p>维护引用计数消耗资源</p>
      </li>
      <li>
        <p>循环引用</p>
      </li>
    </ul>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">list1</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">list2</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">list1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">list2</span><span class="p">)</span>
<span class="n">list2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">list1</span><span class="p">)</span>
</code></pre></div>    </div>

    <p>list1与list2相互引用，如果不存在其他对象对它们的引用，list1与list2的引用计数也仍然为1，所占用的内存永远无法被回收，这将是致命的。对于如今的强大硬件，缺点1尚可接受，但是循环引用导致内存泄露，注定python还将引入新的回收机制。(分代收集)</p>

    <p>GC系统所承担的工作远比”垃圾回收”多得多。实际上，它们负责三个重要任务：</p>

    <ul>
      <li><code class="highlighter-rouge">为新生成的对象分配内存</code></li>
      <li><code class="highlighter-rouge">识别哪些垃圾对象</code></li>
      <li><code class="highlighter-rouge">从垃圾对象那回收内存</code></li>
    </ul>
  </li>
</ul>

<h4 id="5垃圾回收机制">5、垃圾回收机制</h4>

<ul>
  <li>
    <p>1、导致引用计数+1的情况</p>

    <ul>
      <li>对象被创建，如：a = 10</li>
      <li>对象被引用，如：b = a</li>
      <li>对象被作为参数，传递到一个函数中，如：func(a)</li>
      <li>对象作为一个元素，存储在容器中，如：list = [a, a]</li>
    </ul>
  </li>
  <li>
    <p>2、导致引用计数-1的情况：</p>

    <ul>
      <li>对象的别名被显示销毁，如：del a</li>
      <li>对象的别名被赋予新的对象，如：a = 20</li>
      <li>一个对象离开他的作用域， 如函数f执行完毕时，func函数中的局部变量(全局变量不会)</li>
      <li>对象所在的容器被销毁，或从容器中删除对象</li>
    </ul>
  </li>
  <li>
    <p>3、查看一个对象的引用计数</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">a</span> <span class="o">=</span> <span class="s">"hello world"</span>
<span class="n">sys</span><span class="o">.</span><span class="n">getrefcount</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</code></pre></div>    </div>

    <p>可以查看a对象的应用计数，但是比正常计数大1，因为在调用函数的时候传入a，这会让a的引用计数+1</p>
  </li>
</ul>

<h4 id="6循环引用导致内存泄露"><strong>6、</strong>循环引用导致内存泄露</h4>

<p>​	内存泄露：</p>

<p>​	申请了某些内存，但是忘记了释放，那么这就造成了内存的浪费，久而久之内存就不够用了.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">gc</span>

<span class="k">class</span> <span class="nc">ClassA</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'object born,id:</span><span class="si">%</span><span class="s">s'</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">f2</span><span class="p">():</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="n">ClassA</span><span class="p">()</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="n">ClassA</span><span class="p">()</span>
        <span class="n">c1</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">c2</span>
        <span class="n">c2</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">c1</span>
        <span class="k">del</span> <span class="n">c1</span>
        <span class="k">del</span> <span class="n">c2</span>

<span class="c">#python默认是开启垃圾回收的，可以通过下面代码来将其关闭</span>
<span class="n">gc</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>

<span class="n">f2</span><span class="p">()</span>
</code></pre></div></div>

<p>​	执行f2()，进程占用的内存会不断增大。</p>

<ul>
  <li>创建了c1，c2后这两块内存的引用计数都是1，执行<code class="highlighter-rouge">c1.t=c2</code>和<code class="highlighter-rouge">c2.t=c1</code>后，这两块内存的引用计数变成2.</li>
  <li>在del c1后，引用计数变为1，由于不是为0，所以c1对象不会被销毁;同理，c2对象的引用数也是1。</li>
  <li>python默认是开启垃圾回收功能的，但是由于以上程序已经将其关闭，因此导致垃圾回收器都不会回收它们，所以就会导致内存泄露。</li>
</ul>

<h4 id="7垃圾回收"><strong>7、垃圾回收</strong></h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ClassA</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'object born,id:</span><span class="si">%</span><span class="s">s'</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">f2</span><span class="p">():</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="n">ClassA</span><span class="p">()</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="n">ClassA</span><span class="p">()</span>
        <span class="n">c1</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">c2</span>
        <span class="n">c2</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">c1</span>
        <span class="k">del</span> <span class="n">c1</span>
        <span class="k">del</span> <span class="n">c2</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span><span class="c">#手动调用垃圾回收功能，这样在自动垃圾回收被关闭的情况下，也会进行回收</span>

<span class="c">#python默认是开启垃圾回收的，可以通过下面代码来将其关闭</span>
<span class="n">gc</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>

<span class="n">f2</span><span class="p">()</span>
</code></pre></div></div>

<p>​	<strong>有三种情况会触发垃圾回收</strong></p>

<ul>
  <li>当gc模块的计数器达到阀值的时候，自动回收垃圾</li>
  <li>调用gc.collect()，手动回收垃圾</li>
  <li>程序退出的时候，python解释器来回收垃圾</li>
</ul>

<h4 id="8gc模块的自动垃圾回收触发机制">8、gc模块的自动垃圾回收触发机制</h4>

<p>在Python中，采用分代收集的方法。把对象分为三代，一开始，对象在创建的时候，放在一代中，如果在一次一代的垃圾检查中，改对象存活下来，就会被放到二代中，同理在一次二代的垃圾检查中，该对象存活下来，就会被放到三代中。</p>

<p>gc模块里面会有一个长度为3的列表的计数器，可以通过gc.get_count()获取。</p>

<p>例如<code class="highlighter-rouge">(488,3,0)</code>，其中488是指距离上一次一代垃圾检查，Python分配内存的数目减去释放内存的数目，注意是内存分配，而不是引用计数的增加。例如：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span> <span class="n">gc</span><span class="o">.</span><span class="n">get_count</span><span class="p">()</span> <span class="c"># (590, 8, 0)</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">ClassA</span><span class="p">()</span>
<span class="k">print</span> <span class="n">gc</span><span class="o">.</span><span class="n">get_count</span><span class="p">()</span> <span class="c"># (591, 8, 0)</span>
<span class="k">del</span> <span class="n">a</span>
<span class="k">print</span> <span class="n">gc</span><span class="o">.</span><span class="n">get_count</span><span class="p">()</span> <span class="c"># (590, 8, 0)</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">3</code>是指距离上一次二代垃圾检查，一代垃圾检查的次数，同理，<code class="highlighter-rouge">0</code>是指距离上一次三代垃圾检查，二代垃圾检查的次数。</p>

<p>gc模快有一个自动垃圾回收的<code class="highlighter-rouge">阀值</code>，即通过gc.get_threshold函数获取到的长度为3的元组，例如(700,10,10)，每一次计数器的增加，gc模块就会检查增加后的计数是否达到阀值的数目，如果是，就会执行对应的代数的垃圾检查，然后重置计数器。</p>

<p>例如，假设阀值是(700,10,10)：</p>

<blockquote>
  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">当计数器从</span><span class="p">(</span><span class="mi">699</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="err">增加到</span><span class="p">(</span><span class="mi">700</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="err">，</span><span class="n">gc</span><span class="err">模块就会执行</span><span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="err">即检查一代对象的垃圾，并重置计数器为</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="err">当计数器从</span><span class="p">(</span><span class="mi">699</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="err">增加到</span><span class="p">(</span><span class="mi">700</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="err">，</span><span class="n">gc</span><span class="err">模块就会执行</span><span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="err">即检查一、二代对象的垃圾，并重置计数器为</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="err">当计数器从</span><span class="p">(</span><span class="mi">699</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span><span class="err">增加到</span><span class="p">(</span><span class="mi">700</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span><span class="err">，</span><span class="n">gc</span><span class="err">模块就会执行</span><span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="err">即检查一、二、三代对象的垃圾，并重置计数器为</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div>  </div>
</blockquote>

    </article>
    <div class="share">
      <div class="share-component"></div>
    </div>
    <div class="comment">
      

  

  


    </div>
  </div>
  <div class="column one-fourth">
    
<h3>Search</h3>
<div id="site_search">
    <input type="text" id="search_box" placeholder="Search">
</div>

<ul id="search_results"></ul>

<link rel="stylesheet" type="text/css" href="http://localhost:4000/assets/css/modules/sidebar-search.css">
<script src="http://localhost:4000/assets/js/simple-jekyll-search.min.js"></script>
<script src="http://localhost:4000/assets/js/search.js"></script>

<script type="text/javascript">
SimpleJekyllSearch({
    searchInput: document.getElementById('search_box'),
    resultsContainer: document.getElementById('search_results'),
    json: 'http://localhost:4000/assets/search_data.json',
    searchResultTemplate: '<li><a href="{url}" title="{desc}">{title}</a></li>',
    noResultsText: 'No results found',
    limit: 10,
    fuzzy: false,
    exclude: ['Welcome']
})
</script>

    

    
<h3 class="post-directory-title mobile-hidden">Table of Contents</h3>
<div id="post-directory-module" class="mobile-hidden">
  <section class="post-directory">
  <!-- Links that trigger the jumping -->
  <!-- Added by javascript below -->
  <dl></dl>
  </section>
</div>

<script src="http://localhost:4000/assets/js/jquery.toc.js"></script>

  </div>
</div>
</section>
<!-- /section.content -->

    <footer class="container">
        <div class="site-footer" role="contentinfo">
            <div class="copyright left mobile-block">
                    © 2015
                    <span title="Yakun">Yakun</span>
                    <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a>
            </div>

            <ul class="site-footer-links right mobile-hidden">
                <li>
                    <a href="javascript:window.scrollTo(0,0)" >TOP</a>
                </li>
            </ul>
            <a href="http://github.com/AustinKuture/austinkuture.github.io" target="_blank" aria-label="view source code">
                <span class="mega-octicon octicon-mark-github" title="GitHub"></span>
            </a>
            <ul class="site-footer-links mobile-hidden">
                
                <li>
                    <a href="http://localhost:4000/" title="首页" target="">首页</a>
                </li>
                
                <li>
                    <a href="http://localhost:4000/categories/" title="分类" target="">分类</a>
                </li>
                
                <li>
                    <a href="http://localhost:4000/wiki/" title="维基" target="">维基</a>
                </li>
                
                <li>
                    <a href="http://localhost:4000/links/" title="链接" target="">链接</a>
                </li>
                
                <li>
                    <a href="http://localhost:4000/about/" title="关于" target="">关于</a>
                </li>
                
                <li><a href="http://localhost:4000/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li>
            </ul>

        </div>
    </footer>
    <!-- / footer -->
    <script src="http://localhost:4000/assets/vendor/share.js/dist/js/share.min.js"></script>
    <script src="http://localhost:4000/assets/js/geopattern.js"></script>
    <script src="http://localhost:4000/assets/js/prism.js"></script>
    <link rel="stylesheet" href="http://localhost:4000/assets/css/globals/prism.css">
    <script>
      jQuery(document).ready(function($) {
        // geopattern
        $('.geopattern').each(function(){
          $(this).geopattern($(this).data('pattern-id'));
        });
       // hljs.initHighlightingOnLoad();
      });
    </script>

    

    

    

    

    
    <div style="display:none">
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-80669434-1', 'auto');
        ga('send', 'pageview');

      </script>
    </div>
    
</body>
</html>
