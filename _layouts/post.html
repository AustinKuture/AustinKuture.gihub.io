---
layout: default
---
<section class="collection-head small geopattern" data-pattern-id="{{ page.title | truncate: 15, ''}}">
<div class="container">
  <div class="columns">
    <div class="column three-fourths">
      <div class="collection-title">
        <h1 class="collection-header">{{ page.title }}</h1>
        <div class="collection-info">
          {% if page.date %}
          <span class="meta-info">
            <span class="octicon octicon-calendar"></span> {{ page.date | date: "%Y/%m/%d" }}
          </span>
          {% endif %}
          {% for cat in page.categories %}
          <span class="meta-info">
            <span class="octicon octicon-file-directory"></span>
            <a href="{{ site.url }}/categories/#{{ cat }}" title="{{ cat }}">{{ cat }}</a>
          </span>
          {% endfor %}

        </div>
      </div>
    </div>
  </div>
</div>
</section> 
<!-- / .banner -->
 <section class="container content">
<div class="columns">
  <div class="column three-fourths" >
    <article class="article-content markdown-body">
    {{ content }}
    浏览量:&nbsp;<span id="{{ page.url }}" class="leancloud_visitors" data-flag-title="{{ page.title }}"> - </span>次.
    <!-- 流量统计script -->
    <!-- 同时兼容http与https -->
    <script src="//cdn1.lncld.net/static/js/2.5.0/av-min.js"></script>
    <script>
        // 第一个参数是appid，第二个参数是appkey，此处的只是示例
        AV.initialize("OuqtgYuaTMxmXSBx310IKuWY-gzGzoHsz", "AAiznz9nMSOA8uJqrJ9Cay6v");
        // 自己创建的Class的名字
        var name='Counter';
        function createRecord(Counter){
          console.log('5--->CreateRecord');
          // 设置 ACL
          var acl = new AV.ACL();
          acl.setPublicReadAccess(true);
          acl.setPublicWriteAccess(true);
          // 获得span的所有元素
          var elements=document.getElementsByClassName('leancloud_visitors');
          console.log('11--->Elements:');
          console.log(elements);
          // 一次创建多条记录
          var allcounter=[];
          for (var i = 0; i < elements.length ; i++) {
            // 若某span的内容不包括 '-' ，则不必创建记录
            console.log('12--->indexOf:');
            console.log(elements[i].textContent.indexOf('-'));
            if(elements[i].textContent.indexOf('-') == -1){
              continue;
            }
            var title = elements[i].getAttribute('data-flag-title');
            console.log('13--->Title:');
            console.log(title);
            var url = elements[i].id;
            console.log('14--->URL:');
            console.log(url);
            var newcounter = new Counter();
            newcounter.setACL(acl);
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 0);
            console.log('15--->push start');
            allcounter.push(newcounter);
            console.log('16--->push end');
            // 顺便更新显示span为默认值0
            elements[i].textContent=0;
            console.log('17--->Default')
          }
          AV.Object.saveAll(allcounter).then(function (todo) {
            // 成功保存记录之后
            console.log('创建记录成功！');
          }, function (error) {
            // 异常错误 
            console.error('创建记录失败: ' + error.message);
          });
        }
        function showCount(Counter){
          // 是否需要创建新纪录的标志（添加一篇新文章）
          console.log('1--->ShowCount:'+Counter);
          var flag=false;
          var query = new AV.Query(name);
          console.log('2--->QVQuery:');
          console.log(query);
          query.greaterThanOrEqualTo('time', 0);
          query.find().then(function (results) {
            console.log('3--->QueryFind_Results:');
            console.log(results);
            console.log('4--->Results.length:');
            console.log(results.length);
            // 当获取到的记录为0时置默认值
            if(results.length==0){
              $('.leancloud_visitors').text('-');
              flag=true;
              console.log('返回查询记录为空');
              // 如果获取到空记录就创建新记录
              createRecord(Counter);
              return;
            }
            // 将获取到的数据设置为text
            console.log('6--->设置Text:');
            console.log(results);
            for (var i = 0; i < results.length; i++) {
              var item = results[i];
              console.log('7--->Item:');
              console.log(item);
              var url = item.get('url');
              console.log('8--->URL:');
              console.log(url);
              var time = item.get('time');
              console.log('9--->Time:');
              console.log(time);
              var element = document.getElementById(url);
              console.log('10--->Element:');
              console.log(element);
              element.textContent = time;
            }
            // 当某个span含有默认值时说明需要创建记录
            if($('.leancloud_visitors').text().indexOf("-") != -1){
              flag=true;
            }
            // 当获取的记录数与span个数不吻合时
            if(results.length != $('.leancloud_visitors').length){
              flag=true;
            }
            if(flag){
              createRecord(Counter);
            }
          }, function (error) {
            console.log('query error:'+error.message);
          });
        }
        $(function() {
          console.log('0---入口:'+name);
          var Counter = AV.Object.extend(name);
          showCount(Counter);
        });
    </script>
    </article>
    <div class="share">
      {% include sns-share.html %}
    </div>
    <!-- 添加just-comments评论功能 START -->
    <!--<div -->
      <!--class="just-comments" -->
      <!--data-allowguests="true" -->
      <!--data-apikey="48bdecb9-a299-492a-8dfe-105cc532d084">-->
    <!--</div>-->
    <!-- 添加just-comments评论功能 END -->

  </div>
  <div class="column one-fourth">
    {% include sidebar-search.html %}
    {% include sidebar-qrcode.html %}
    {% include sidebar-post-nav.html %}
  </div>
</div>
</section>





<!-- /section.content -->
